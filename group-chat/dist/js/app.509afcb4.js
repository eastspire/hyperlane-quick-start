(function(){"use strict";var e={4253:function(e,t,n){var s=n(5130),o=n(6768);function a(e,t,n,s,a,r){const i=(0,o.g2)("router-view");return(0,o.uX)(),(0,o.Wv)(i)}var r={name:"App"},i=n(1241);const c=(0,i.A)(r,[["render",a]]);var l=c,u=n(1387);const d={class:"chat-view"};function h(e,t,n,s,a,r){const i=(0,o.g2)("MessageList"),c=(0,o.g2)("ScrollToBottomButton"),l=(0,o.g2)("ConnectionStatus"),u=(0,o.g2)("ChatInput");return(0,o.uX)(),(0,o.CE)("div",d,[(0,o.bF)(i,{messages:a.messages,isNearBottom:a.isNearBottom,username:a.username,onHandleScroll:r.handleScroll,ref:"messageListRef"},null,8,["messages","isNearBottom","username","onHandleScroll"]),a.showScrollButton?((0,o.uX)(),(0,o.Wv)(c,{key:0,unreadCount:a.unreadCount,onClick:r.scrollToBottom},null,8,["unreadCount","onClick"])):(0,o.Q3)("",!0),"connected"!==a.connectionStatus?((0,o.uX)(),(0,o.Wv)(l,{key:1,status:a.connectionStatus},null,8,["status"])):(0,o.Q3)("",!0),(0,o.bF)(u,{connectionStatus:a.connectionStatus,onSendMessage:r.sendMessage},null,8,["connectionStatus","onSendMessage"])])}n(4114);var m=n(4232);const g={class:"message-info"},v={class:"message-content"},f={class:"text"},p={class:"message-info self"},S={class:"message-content self"},k={class:"text"};function C(e,t,n,s,a,r){const i=(0,o.g2)("MessageAvatar"),c=(0,o.g2)("MessageHeader"),l=(0,o.g2)("ScrollList");return(0,o.uX)(),(0,o.Wv)(l,{class:"chat-messages",ref:"messageContainer",items:n.messages,containerHeight:a.containerHeight,estimatedItemHeight:80,bufferSize:5,onHandleScroll:r.handleScroll},{default:(0,o.k6)((({item:e})=>[(0,o.Lk)("div",{class:(0,m.C4)(["message",e.isSelf?"self-message":"other-message"])},[e.isSelf?((0,o.uX)(),(0,o.CE)(o.FK,{key:1},[(0,o.Lk)("div",p,[(0,o.bF)(c,{sender:e.sender,time:e.time,isSelf:!0},null,8,["sender","time"]),(0,o.Lk)("div",S,[(0,o.Lk)("div",k,(0,m.v_)(e.text),1)])]),(0,o.bF)(i,{sender:e.sender,isSelf:!0},null,8,["sender"])],64)):((0,o.uX)(),(0,o.CE)(o.FK,{key:0},[(0,o.bF)(i,{sender:e.sender,isSelf:!1},null,8,["sender"]),(0,o.Lk)("div",g,[(0,o.bF)(c,{sender:e.sender,time:e.time,isSelf:!1},null,8,["sender","time"]),(0,o.Lk)("div",v,[(0,o.Lk)("div",f,(0,m.v_)(e.text),1)])])],64))],2)])),_:1},8,["items","containerHeight","onHandleScroll"])}function b(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",{class:(0,m.C4)(["avatar",n.isSelf?"self":""])},(0,m.v_)(n.sender.charAt(0)),3)}var w={name:"MessageAvatar",props:{sender:{type:String,required:!0},isSelf:{type:Boolean,default:!1}}};const y=(0,i.A)(w,[["render",b],["__scopeId","data-v-9166247c"]]);var B=y;const L={class:"message-header"},M={class:"sender"},_={class:"time"},H={class:"time"},T={class:"sender"};function A(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",L,[n.isSelf?((0,o.uX)(),(0,o.CE)(o.FK,{key:1},[(0,o.Lk)("div",H,(0,m.v_)(n.time),1),(0,o.Lk)("div",T,(0,m.v_)(n.sender),1)],64)):((0,o.uX)(),(0,o.CE)(o.FK,{key:0},[(0,o.Lk)("div",M,(0,m.v_)(n.sender),1),(0,o.Lk)("div",_,(0,m.v_)(n.time),1)],64))])}var E={name:"MessageHeader",props:{sender:{type:String,required:!0},time:{type:String,required:!0},isSelf:{type:Boolean,default:!1}}};const $=(0,i.A)(E,[["render",A],["__scopeId","data-v-537b97e0"]]);var x=$;const N={class:"list-content"};function X(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",{class:"list-container",ref:"container",onScroll:t[0]||(t[0]=(...e)=>r.onScroll&&r.onScroll(...e)),style:(0,m.Tr)({height:n.containerHeight+"px"})},[(0,o.Lk)("div",N,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(n.items,((t,n)=>(0,o.RG)(e.$slots,"default",{item:t,index:n,key:n},void 0,!0))),128))])],36)}var O={name:"ScrollList",props:{items:{type:Array,required:!0},containerHeight:{type:Number,default:500}},methods:{onScroll(e){const t=e.target.scrollTop,n=e.target.clientHeight,s=e.target.scrollHeight-t-n,o=s<100;this.$emit("handleScroll",o)},scrollToBottom(){this.$refs.container&&requestAnimationFrame((()=>{this.$refs.container.scrollTop=this.$refs.container.scrollHeight}))}}};const F=(0,i.A)(O,[["render",X],["__scopeId","data-v-61a4da06"]]);var I=F,W={name:"MessageList",components:{MessageAvatar:B,MessageHeader:x,ScrollList:I},props:{messages:{type:Array,required:!0},isNearBottom:{type:Boolean,default:!0},username:{type:String,required:!0}},data(){return{containerHeight:0}},mounted(){this.updateContainerHeight(),window.addEventListener("resize",this.updateContainerHeight)},beforeUnmount(){window.removeEventListener("resize",this.updateContainerHeight)},methods:{updateContainerHeight(){this.containerHeight=window.innerHeight-108},scrollToBottom(){const e=this.$refs.messageContainer;e&&e.scrollToBottom()},handleScroll(e){this.$emit("handleScroll",e)}}};const q=(0,i.A)(W,[["render",C],["__scopeId","data-v-89eb8ffe"]]);var j=q;const K={class:"chat-input"},R=["disabled"],D=["disabled"];function U(e,t,n,a,r,i){return(0,o.uX)(),(0,o.CE)("div",K,[(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>r.message=e),onKeyup:t[1]||(t[1]=(0,s.jR)(((...e)=>i.sendMessage&&i.sendMessage(...e)),["enter"])),placeholder:"输入消息...",disabled:"connected"!==n.connectionStatus},null,40,R),[[s.Jo,r.message]]),(0,o.Lk)("button",{onClick:t[2]||(t[2]=(...e)=>i.sendMessage&&i.sendMessage(...e)),disabled:"connected"!==n.connectionStatus},t[3]||(t[3]=[(0,o.Lk)("span",null,"发送",-1),(0,o.Lk)("i",{class:"send-icon"},"➤",-1)]),8,D)])}var z={name:"ChatInput",props:{connectionStatus:{type:String,required:!0}},data(){return{message:""}},methods:{sendMessage(){this.message.trim()&&"connected"===this.connectionStatus&&(this.$emit("send-message",this.message),this.message="")}}};const P=(0,i.A)(z,[["render",U],["__scopeId","data-v-f40e23b0"]]);var J=P;const Q={class:"connection-status"};function V(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",Q,[t[0]||(t[0]=(0,o.Lk)("i",{class:"status-icon"},"⚠️",-1)),(0,o.eW)(" "+(0,m.v_)(r.statusMessage),1)])}var G={name:"ConnectionStatus",props:{status:{type:String,required:!0}},computed:{statusMessage(){const e={disconnected:"未连接到服务器",connecting:"正在连接...",connected:"已连接"};return e[this.status]||"未知状态"}}};const Y=(0,i.A)(G,[["render",V],["__scopeId","data-v-74e6b716"]]);var Z=Y;const ee={key:0,class:"unread-count"};function te(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",{class:"scroll-to-bottom",onClick:t[0]||(t[0]=t=>e.$emit("click"))},[n.unreadCount>0?((0,o.uX)(),(0,o.CE)("span",ee,(0,m.v_)(n.unreadCount),1)):(0,o.Q3)("",!0),t[1]||(t[1]=(0,o.Lk)("i",{class:"scroll-icon"},"↓",-1))])}var ne={name:"ScrollToBottomButton",props:{unreadCount:{type:Number,default:0}}};const se=(0,i.A)(ne,[["render",te],["__scopeId","data-v-03c24de7"]]);var oe=se,ae=n(144);function re({onMessage:e}){const t=(0,ae.KR)(null),n=(0,ae.KR)("disconnected");let s=0;const o=5,a=3e3,r=()=>{n.value="connecting";const o="https:"===window.location.protocol?"wss":"ws",a="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"localhost:60007":window.location.hostname;t.value=new WebSocket(`${o}://${a}/websocket`),t.value.onopen=()=>{n.value="connected",console.log("WebSocket连接已建立"),t.value.send(""),setInterval((()=>{t.value&&t.value.readyState===WebSocket.OPEN&&t.value.send("")}),1e4)},t.value.onmessage=t=>{console.log("收到消息:",t.data);try{let n;try{n=JSON.parse(t.data)}catch{n={sender:"系统消息",text:t.data}}e(n)}catch(n){console.error("处理消息失败:",n)}},t.value.onclose=()=>{n.value="disconnected",console.log("WebSocket连接已关闭"),c()},t.value.onerror=e=>{n.value="disconnected",console.error("WebSocket错误:",e)},s=0},i=()=>{t.value&&(t.value.close(),t.value=null)},c=()=>{s<o?(s++,console.log(`尝试重新连接 (${s}/${o})...`),setTimeout((()=>{r()}),a)):console.error("达到最大重连次数，停止重连")},l=e=>!(!t.value||t.value.readyState!==WebSocket.OPEN)&&(t.value.send(JSON.stringify(e)),!0);return{connectionStatus:n,connect:r,disconnect:i,sendMessage:l}}var ie={name:"ChatView",components:{MessageList:j,ChatInput:J,ConnectionStatus:Z,ScrollToBottomButton:oe},data(){return{messages:[],username:"",isNearBottom:!0,showScrollButton:!1,unreadCount:0,connectionStatus:"disconnected"}},created(){this.username=this.generateUsername()},mounted(){const{connectionStatus:e,connect:t,disconnect:n,sendMessage:s}=re({onMessage:this.handleMessage});this.connect=t,this.disconnect=n,this.sendWebSocketMessage=s,this.wsConnectionStatus=e,this.connectionStatus=e.value,this.$watch((()=>this.wsConnectionStatus.value),(e=>{console.log("WebSocket连接状态变化:",e),this.connectionStatus=e})),this.connect()},beforeUnmount(){this.disconnect()},methods:{generateFingerprint(){const e=[navigator.userAgent,navigator.language,navigator.platform,navigator.vendor,screen.colorDepth,screen.width+"x"+screen.height,(new Date).getTimezoneOffset()].join("|");let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t|=0}return Math.abs(t)%1e4},generateUsername(){const e=1e3*(new Date).getTime(),t=this.generateFingerprint();return`用户${e}-${t}`},handleMessage(e){try{const t=e.sender===this.username;this.messages.push({sender:e.sender,text:e.text,time:(new Date).toLocaleTimeString(),isSelf:t}),this.$nextTick((()=>{console.log(this.isNearBottom),t||this.isNearBottom?this.scrollToBottom():(this.unreadCount++,this.showScrollButton=!0)}))}catch(t){console.error("处理消息失败:",t)}},sendMessage(e){if(!e.trim()||"connected"!==this.connectionStatus)return;const t={sender:this.username,text:e,time:(new Date).toLocaleTimeString()};this.isNearBottom=!0,this.sendWebSocketMessage(t)},scrollToBottom(){this.$nextTick((()=>{this.$refs.messageListRef&&(this.$refs.messageListRef.scrollToBottom(),this.unreadCount=0,this.showScrollButton=!1,this.isNearBottom=!0)}))},handleScroll(e){this.isNearBottom=e,this.isNearBottom&&this.showScrollButton&&(this.showScrollButton=!1,this.unreadCount=0)}}};const ce=(0,i.A)(ie,[["render",h],["__scopeId","data-v-2e43de33"]]);var le=ce;const ue=[{path:"/",name:"chat",component:le}],de=(0,u.aE)({history:(0,u.LA)("/"),routes:ue});var he=de;const me=(0,s.Ef)(l);me.use(he),me.mount("#app")}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,n),a.exports}n.m=e,function(){var e=[];n.O=function(t,s,o,a){if(!s){var r=1/0;for(u=0;u<e.length;u++){s=e[u][0],o=e[u][1],a=e[u][2];for(var i=!0,c=0;c<s.length;c++)(!1&a||r>=a)&&Object.keys(n.O).every((function(e){return n.O[e](s[c])}))?s.splice(c--,1):(i=!1,a<r&&(r=a));if(i){e.splice(u--,1);var l=o();void 0!==l&&(t=l)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--)e[u]=e[u-1];e[u]=[s,o,a]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};n.O.j=function(t){return 0===e[t]};var t=function(t,s){var o,a,r=s[0],i=s[1],c=s[2],l=0;if(r.some((function(t){return 0!==e[t]}))){for(o in i)n.o(i,o)&&(n.m[o]=i[o]);if(c)var u=c(n)}for(t&&t(s);l<r.length;l++)a=r[l],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(u)},s=self["webpackChunkgroup_chat"]=self["webpackChunkgroup_chat"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=n.O(void 0,[504],(function(){return n(4253)}));s=n.O(s)})();