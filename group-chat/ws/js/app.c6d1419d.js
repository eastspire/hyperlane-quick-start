(function(){"use strict";var e={1623:function(e,t,n){var s=n(5130),o=n(6768);function a(e,t,n,s,a,r){const i=(0,o.g2)("router-view");return(0,o.uX)(),(0,o.Wv)(i)}var r={name:"App"},i=n(1241);const c=(0,i.A)(r,[["render",a]]);var l=c,u=n(1387),d=n(4232);const h={class:"chat-view"},m={class:"nav-bar"},g={class:"chat-container"};function v(e,t,n,s,a,r){const i=(0,o.g2)("MessageList"),c=(0,o.g2)("ScrollToBottomButton"),l=(0,o.g2)("ConnectionStatus"),u=(0,o.g2)("ChatInput");return(0,o.uX)(),(0,o.CE)("div",h,[(0,o.Lk)("div",m,[t[1]||(t[1]=(0,o.Lk)("h1",{class:"nav-title"},[(0,o.Lk)("a",{href:"https://github.com/eastspire/hyperlane",target:"_blank"}," Hyperlane Chat ")],-1)),(0,o.Lk)("div",{class:(0,d.C4)(["connection-indicator",a.connectionStatus])},[t[0]||(t[0]=(0,o.Lk)("span",{class:"status-dot"},null,-1)),(0,o.eW)(" "+(0,d.v_)("connected"===a.connectionStatus?"在线":"离线"),1)],2)]),(0,o.Lk)("div",g,[(0,o.bF)(i,{messages:a.messages,isNearBottom:a.isNearBottom,name:a.username,onHandleScroll:r.handleScroll,ref:"messageListRef"},null,8,["messages","isNearBottom","name","onHandleScroll"]),a.showScrollButton?((0,o.uX)(),(0,o.Wv)(c,{key:0,unreadCount:a.unreadCount,onClick:r.scrollToBottom},null,8,["unreadCount","onClick"])):(0,o.Q3)("",!0),"connected"!==a.connectionStatus?((0,o.uX)(),(0,o.Wv)(l,{key:1,status:a.connectionStatus},null,8,["status"])):(0,o.Q3)("",!0),(0,o.bF)(u,{connectionStatus:a.connectionStatus,onSendMessage:r.sendMessage},null,8,["connectionStatus","onSendMessage"])])])}n(4114);const f={class:"message-info"},p={class:"message-content"},S={class:"text"},k={class:"message-time"},C={class:"message-info self"},b={class:"message-content self"},w={class:"text"},y={class:"message-time"};function L(e,t,n,s,a,r){const i=(0,o.g2)("MessageAvatar"),c=(0,o.g2)("MessageHeader"),l=(0,o.g2)("ScrollList");return(0,o.uX)(),(0,o.Wv)(l,{class:"chat-messages",ref:"messageContainer",items:n.messages,containerHeight:a.containerHeight,estimatedItemHeight:80,bufferSize:5,onHandleScroll:r.handleScroll},{default:(0,o.k6)((({item:e})=>[(0,o.Lk)("div",{class:(0,d.C4)(["message",r.isMe(e)?"self-message":"other-message"])},[r.isMe(e)?((0,o.uX)(),(0,o.CE)(o.FK,{key:1},[(0,o.Lk)("div",C,[(0,o.bF)(c,{name:e.name,time:e.time,isSelf:!0},null,8,["name","time"]),(0,o.Lk)("div",b,[(0,o.Lk)("div",w,(0,d.v_)(e.data),1)]),(0,o.Lk)("div",y,(0,d.v_)(e.time),1)]),(0,o.bF)(i,{name:e.name,isSelf:!0},null,8,["name"])],64)):((0,o.uX)(),(0,o.CE)(o.FK,{key:0},[(0,o.bF)(i,{name:e.name,isSelf:!1},null,8,["name"]),(0,o.Lk)("div",f,[(0,o.bF)(c,{name:e.name,time:e.time,isSelf:!1},null,8,["name","time"]),(0,o.Lk)("div",p,[(0,o.Lk)("div",S,(0,d.v_)(e.data),1)]),(0,o.Lk)("div",k,(0,d.v_)(e.time),1)])],64))],2)])),_:1},8,["items","containerHeight","onHandleScroll"])}function B(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",{class:(0,d.C4)(["avatar",n.isSelf?"self":""])},(0,d.v_)(n.name?.charAt(0)),3)}var M={name:"MessageAvatar",props:{name:{type:String,required:!0},isSelf:{type:Boolean,default:!1}}};const _=(0,i.A)(M,[["render",B],["__scopeId","data-v-26cceab0"]]);var H=_;const $={class:"message-header"},T={class:"name"};function A(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",$,[(0,o.Lk)("div",T,(0,d.v_)(n.name),1)])}var I={name:"MessageHeader",props:{name:{type:String,required:!0},time:{type:String,required:!0},isSelf:{type:Boolean,default:!1}}};const E=(0,i.A)(I,[["render",A],["__scopeId","data-v-08b501d0"]]);var O=E;const x={class:"list-content"};function N(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",{class:"list-container",ref:"container",onScroll:t[0]||(t[0]=(...e)=>r.onScroll&&r.onScroll(...e)),style:(0,d.Tr)({height:n.containerHeight+"px"})},[(0,o.Lk)("div",x,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(n.items,((t,n)=>(0,o.RG)(e.$slots,"default",{item:t,index:n,key:n},void 0,!0))),128))])],36)}var X={name:"ScrollList",props:{items:{type:Array,required:!0},containerHeight:{type:Number,default:500}},data(){return{canScroll:!1}},methods:{onScroll(e){const t=e.target,n=t.scrollTop,s=t.clientHeight,o=t.scrollHeight,a=o-n-s,r=a<100;this.$emit("handleScroll",r)},scrollToBottom(){if(!this.$refs.container)return;const e=this.$refs.container,t=e.scrollHeight,n=e.clientHeight;t>n&&requestAnimationFrame((()=>{e.scrollTop=e.scrollHeight}))},checkScrollable(){if(!this.$refs.container)return!1;const e=this.$refs.container,t=e.scrollHeight,n=e.clientHeight;return this.canScroll=t>n,this.canScroll}},watch:{items:{handler(){this.$nextTick((()=>{this.checkScrollable()}))},deep:!0}}};const W=(0,i.A)(X,[["render",N],["__scopeId","data-v-cd1a88b2"]]);var F=W;const q=function(){const e="browser_uuid";let t=localStorage.getItem(e);return t||(t=crypto.randomUUID(),localStorage.setItem(e,t)),t};var U={name:"MessageList",components:{MessageAvatar:H,MessageHeader:O,ScrollList:F},props:{messages:{type:Array,required:!0},isNearBottom:{type:Boolean,default:!0},name:{type:String,required:!0}},data(){return{containerHeight:0,shouldAutoScroll:!0}},mounted(){this.updateContainerHeight(),window.addEventListener("resize",this.updateContainerHeight)},beforeUnmount(){window.removeEventListener("resize",this.updateContainerHeight)},methods:{isMe(e){return e?.name==q()},updateContainerHeight(){this.containerHeight=window.innerHeight-108},scrollToBottom(){const e=this.$refs.messageContainer;if(e){const t=e.checkScrollable();t&&e.scrollToBottom()}},handleScroll(e){const t=this.$refs.messageContainer;t&&t.canScroll?this.$emit("handleScroll",e):this.$emit("handleScroll",!0)}},watch:{messages:{handler(){this.$nextTick((()=>{const e=this.$refs.messageContainer;if(e){const t=e.checkScrollable();t&&this.shouldAutoScroll&&this.scrollToBottom()}}))},deep:!0}}};const R=(0,i.A)(U,[["render",L],["__scopeId","data-v-0325bcc4"]]);var j=R;const K={class:"chat-input"},P=["disabled"],z=["disabled"];function D(e,t,n,a,r,i){return(0,o.uX)(),(0,o.CE)("div",K,[(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>r.message=e),onKeyup:t[1]||(t[1]=(0,s.jR)(((...e)=>i.sendMessage&&i.sendMessage(...e)),["enter"])),placeholder:"输入消息...",disabled:"connected"!==n.connectionStatus},null,40,P),[[s.Jo,r.message]]),(0,o.Lk)("button",{onClick:t[2]||(t[2]=(...e)=>i.sendMessage&&i.sendMessage(...e)),disabled:"connected"!==n.connectionStatus},t[3]||(t[3]=[(0,o.Lk)("span",null,"发送",-1),(0,o.Lk)("i",{class:"send-icon"},"➤",-1)]),8,z)])}var J={name:"ChatInput",props:{connectionStatus:{type:String,required:!0}},data(){return{message:""}},methods:{sendMessage(){this.message.trim()&&"connected"===this.connectionStatus&&(this.$emit("send-message",this.message),this.message="")}}};const Q=(0,i.A)(J,[["render",D],["__scopeId","data-v-075afd32"]]);var V=Q;const G={class:"connection-status"};function Y(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",G,[t[0]||(t[0]=(0,o.Lk)("i",{class:"status-icon"},"⚠️",-1)),(0,o.eW)(" "+(0,d.v_)(r.statusMessage),1)])}var Z={name:"ConnectionStatus",props:{status:{type:String,required:!0}},computed:{statusMessage(){const e={disconnected:"未连接到服务器",connecting:"正在连接...",connected:"已连接"};return e[this.status]||"未知状态"}}};const ee=(0,i.A)(Z,[["render",Y],["__scopeId","data-v-6d98f285"]]);var te=ee;const ne={key:0,class:"unread-count"};function se(e,t,n,s,a,r){return(0,o.uX)(),(0,o.CE)("div",{class:"scroll-to-bottom",onClick:t[0]||(t[0]=t=>e.$emit("click"))},[n.unreadCount>0?((0,o.uX)(),(0,o.CE)("span",ne,(0,d.v_)(n.unreadCount),1)):(0,o.Q3)("",!0),t[1]||(t[1]=(0,o.Lk)("i",{class:"scroll-icon"},"↓",-1))])}var oe={name:"ScrollToBottomButton",props:{unreadCount:{type:Number,default:0}}};const ae=(0,i.A)(oe,[["render",se],["__scopeId","data-v-39a3df12"]]);var re=ae,ie=n(144);const ce=q();function le({onMessage:e}){const t=(0,ie.KR)(null),n=(0,ie.KR)("disconnected");let s=0;const o=5,a=3e3;let r=null;const i=()=>{n.value="connecting";const o="https:"===window.location.protocol?"wss":"ws",a="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"localhost:60006":window.location.hostname;t.value=new WebSocket(`${o}://${a}/api/ws?uuid=${ce}`),t.value.onopen=()=>{n.value="connected",clearInterval(r),r=setInterval((()=>{u({type:"Ping",data:""})}),8888)},t.value.onmessage=t=>{try{let n=JSON.parse(t.data);if("Pang"==n.type)return;e(n)}catch(n){e({name:"System",data:t.data,time:(new Date).toLocaleTimeString()})}},t.value.onclose=()=>{n.value="disconnected",l()},t.value.onerror=e=>{n.value="disconnected",console.error("WebSocket错误:",e)},s=0},c=()=>{t.value&&(t.value.close(),t.value=null)},l=()=>{s<o?(s++,setTimeout((()=>{i()}),a)):console.error("达到最大重连次数，停止重连")},u=e=>!(!t.value||t.value.readyState!==WebSocket.OPEN)&&(t.value.send(JSON.stringify(e)),!0);return{connectionStatus:n,connect:i,disconnect:c,sendMessage:u}}const ue={OnlineCount:"OnlineCount"};var de={name:"ChatView",components:{MessageList:j,ChatInput:V,ConnectionStatus:te,ScrollToBottomButton:re},data(){return{messages:[],username:"",isNearBottom:!0,showScrollButton:!1,unreadCount:0,connectionStatus:"disconnected"}},created(){this.username=this.generateUsername()},mounted(){const{connectionStatus:e,connect:t,disconnect:n,sendMessage:s}=le({onMessage:this.handleMessage});this.connect=t,this.disconnect=n,this.sendWebSocketMessage=s,this.wsConnectionStatus=e,this.connectionStatus=e.value,this.$watch((()=>this.wsConnectionStatus.value),(e=>{console.log("WebSocket连接状态变化:",e),this.connectionStatus=e})),this.connect()},beforeUnmount(){this.disconnect()},methods:{generateUsername(){const e=crypto.randomUUID();return`用户${e}`},handleMessage(e){const t=e.name===this.username;this.messages.push({...e,isSelf:t}),this.$nextTick((()=>{const e=this.$refs.messageListRef;if(!e)return;const n=e.$refs.messageContainer.checkScrollable();if(!n)return this.showScrollButton=!1,void(this.unreadCount=0);t||this.isNearBottom?this.scrollToBottom():(this.unreadCount++,this.showScrollButton=!0)}))},sendMessage(e){if(!e.trim()||"connected"!==this.connectionStatus)return;const t={type:ue.OnlineCount,data:e};this.isNearBottom=!0,this.sendWebSocketMessage(t)},scrollToBottom(){this.$nextTick((()=>{this.$refs.messageListRef&&(this.$refs.messageListRef.scrollToBottom(),this.unreadCount=0,this.showScrollButton=!1,this.isNearBottom=!0)}))},handleScroll(e){this.isNearBottom=e,this.isNearBottom&&this.showScrollButton&&(this.showScrollButton=!1,this.unreadCount=0)}}};const he=(0,i.A)(de,[["render",v],["__scopeId","data-v-0d2b5e16"]]);var me=he;const ge=!1,ve=[{path:ge?"/":"/ws/index.html",name:"chat",component:me}],fe=(0,u.aE)({history:(0,u.LA)(""),routes:ve});var pe=fe;const Se=(0,s.Ef)(l);Se.use(pe),Se.mount("#app")}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,n),a.exports}n.m=e,function(){var e=[];n.O=function(t,s,o,a){if(!s){var r=1/0;for(u=0;u<e.length;u++){s=e[u][0],o=e[u][1],a=e[u][2];for(var i=!0,c=0;c<s.length;c++)(!1&a||r>=a)&&Object.keys(n.O).every((function(e){return n.O[e](s[c])}))?s.splice(c--,1):(i=!1,a<r&&(r=a));if(i){e.splice(u--,1);var l=o();void 0!==l&&(t=l)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--)e[u]=e[u-1];e[u]=[s,o,a]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};n.O.j=function(t){return 0===e[t]};var t=function(t,s){var o,a,r=s[0],i=s[1],c=s[2],l=0;if(r.some((function(t){return 0!==e[t]}))){for(o in i)n.o(i,o)&&(n.m[o]=i[o]);if(c)var u=c(n)}for(t&&t(s);l<r.length;l++)a=r[l],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(u)},s=self["webpackChunkgroup_chat"]=self["webpackChunkgroup_chat"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=n.O(void 0,[504],(function(){return n(1623)}));s=n.O(s)})();